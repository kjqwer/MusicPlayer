name: Build and Release

on:
  # æ™®é€šæ¨é€æ—¶è‡ªåŠ¨æ„å»ºï¼Œæ¨é€ tag æ—¶è§¦å‘å‘ç‰ˆ
  push:
    branches: [ main, master ]
    tags:
      - 'v*.*.*'
    paths-ignore:
      - '**.md'
      - '.gitignore'

env:
  DOTNET_VERSION: '10.0.x'
  PROJECT_PATH: 'MusicPlayer.csproj'
  PUBLISH_PATH: './publish'

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: å®‰è£… .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        dotnet-quality: 'preview'

    - name: ç¼“å­˜ NuGet åŒ…
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: æ¢å¤ä¾èµ–
      run: dotnet restore ${{ env.PROJECT_PATH }}

    - name: å‘å¸ƒé¡¹ç›®
      run: |
        dotnet publish ${{ env.PROJECT_PATH }} -c Release -r win-x64 --self-contained true -p:PublishSingleFile=true -p:IncludeNativeLibrariesForSelfExtract=true -p:EnableCompressionInSingleFile=true -p:PublishTrimmed=true -p:TrimMode=partial -o ${{ env.PUBLISH_PATH }}

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: MusicPlayer-win-x64
        path: ${{ env.PUBLISH_PATH }}/MusicPlayer.exe
        retention-days: 30

  release:
    # ä»…åœ¨æ¨é€ tag æ—¶æ‰§è¡Œå‘ç‰ˆ
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è·å–ç‰ˆæœ¬å·å’Œå‘å¸ƒè¯´æ˜
      id: get_info
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        # è·å– tag çš„æ³¨é‡Šä¿¡æ¯
        NOTES=$(git tag -l --format='%(contents)' "v$VERSION" | head -20)
        echo "NOTES<<EOF" >> $GITHUB_OUTPUT
        echo "$NOTES" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        name: MusicPlayer-win-x64
        path: ./release

    - name: åˆ›å»ºå‹ç¼©åŒ…
      run: |
        cd release
        zip -r ../MusicPlayer-v${{ steps.get_info.outputs.VERSION }}-win-x64.zip .

    - name: åˆ›å»º GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        name: MusicPlayer v${{ steps.get_info.outputs.VERSION }}
        body: |
          ## ğŸµ HiFi Music Player v${{ steps.get_info.outputs.VERSION }}
          
          ${{ steps.get_info.outputs.NOTES }}
          
          ### ä¸‹è½½
          - `MusicPlayer-v${{ steps.get_info.outputs.VERSION }}-win-x64.zip` - Windows x64 å•æ–‡ä»¶ç‰ˆæœ¬
          
          ### ç³»ç»Ÿè¦æ±‚
          - Windows 10 19041 æˆ–æ›´é«˜ç‰ˆæœ¬
        files: |
          MusicPlayer-v${{ steps.get_info.outputs.VERSION }}-win-x64.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
